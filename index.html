<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bazar Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f8fafc; }
    .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb; }
    .thumb.active { outline: 2px solid #3b82f6; }
  </style>
</head>
<body class="min-h-screen text-gray-800">
  <!-- –®–∞–ø–∫–∞ -->
  <header class="sticky top-0 bg-white border-b p-3">
    <div class="flex justify-between items-center">
      <h1 class="font-bold text-xl">üõçÔ∏è Bazar Live</h1>
      <div id="authBar"></div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="container mx-auto p-3">
    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="mb-4 flex flex-col gap-2">
      <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫..." class="border p-2 rounded-lg">
      <div class="flex gap-2">
        <select id="sortSelect" class="border p-2 rounded-lg flex-1">
          <option value="new">–ù–æ–≤—ã–µ</option>
          <option value="cheap">–î–µ—à–µ–≤—ã–µ</option>
        </select>
        <button id="addBtn" class="bg-blue-600 text-white p-2 rounded-lg">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
    <div id="adsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    
    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div id="emptyState" class="hidden text-center py-10 text-gray-500">
      <p>–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <dialog id="adModal" class="w-full max-w-md rounded-lg border p-0">
    <form method="dialog" class="p-4">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold text-lg">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
        <button id="closeModal" class="text-xl">&times;</button>
      </div>
      
      <div class="space-y-3">
        <input id="adTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ*" class="w-full border p-2 rounded-lg" required>
        <textarea id="adDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ*" rows="3" class="w-full border p-2 rounded-lg" required></textarea>
        <div class="grid grid-cols-2 gap-3">
          <input id="adPrice" type="number" placeholder="–¶–µ–Ω–∞*" class="border p-2 rounded-lg" required>
          <select id="adCurrency" class="border p-2 rounded-lg">
            <option value="RUB">‚ÇΩ</option>
            <option value="USD">$</option>
          </select>
        </div>
        <input id="adLocation" placeholder="–ì–æ—Ä–æ–¥*" class="w-full border p-2 rounded-lg" required>
        <input id="adPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω*" class="w-full border p-2 rounded-lg" required>
        
        <div>
          <label class="block mb-1">–§–æ—Ç–æ (–º–∞–∫—Å. 3):</label>
          <input id="adImages" type="file" accept="image/*" multiple class="w-full border p-2 rounded-lg">
          <div id="adThumbs" class="flex gap-2 mt-2"></div>
          <img id="adPreview" class="mt-2 w-full hidden border rounded-lg">
        </div>
        
        <button id="saveAd" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
      </div>
    </form>
  </dialog>

  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
  <dialog id="viewDialog" class="w-full max-w-md rounded-lg border p-0">
    <div class="p-4">
      <div class="aspect-[4/3] bg-gray-100 rounded-lg mb-3 overflow-hidden">
        <img id="viewImg" class="w-full h-full object-cover">
      </div>
      
      <div class="space-y-2">
        <h3 id="viewTitle" class="font-bold text-lg"></h3>
        <div class="flex items-center gap-2">
          <span id="viewPrice" class="font-bold"></span>
          <span id="viewLocation" class="text-sm text-gray-600"></span>
        </div>
        
        <div id="viewThumbs" class="flex gap-2 my-2"></div>
        
        <p id="viewDesc" class="text-gray-700"></p>
        <a id="viewPhone" class="block bg-green-600 text-white text-center p-3 rounded-lg font-bold">
          –ü–æ–∑–≤–æ–Ω–∏—Ç—å
        </a>
        
        <div id="ownerActions" class="hidden grid grid-cols-2 gap-2 mt-2">
          <button id="editAdBtn" class="bg-gray-800 text-white p-2 rounded-lg">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          <button id="deleteAdBtn" class="bg-red-600 text-white p-2 rounded-lg">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        
        <div class="text-sm text-gray-500 mt-3">
          <span id="viewUser"></span>
        </div>
        
        <button id="closeView" class="w-full mt-3 border p-2 rounded-lg">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </dialog>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Firebase config (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
    const firebaseConfig = {
      apiKey: "AIzaSyB7lkappg-4omdbOQ9xa-zgBH81Tq5mr4U",
      authDomain: "bazarlive-732c1.firebaseapp.com",
      projectId: "bazarlive-732c1",
      storageBucket: "bazarlive-732c1.appspot.com",
      messagingSenderId: "67666176855",
      appId: "1:67666176855:web:d8fc58628deaca3652ec12"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const authBar = document.getElementById('authBar');
    const addBtn = document.getElementById('addBtn');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const adsGrid = document.getElementById('adsGrid');
    const emptyState = document.getElementById('emptyState');
    const adModal = document.getElementById('adModal');
    const closeModal = document.getElementById('closeModal');
    const saveAd = document.getElementById('saveAd');
    const viewDialog = document.getElementById('viewDialog');
    const closeView = document.getElementById('closeView');

    // –î–∞–Ω–Ω—ã–µ
    let currentUser = null;
    let ads = [];
    let editingAdId = null;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
    const formatPrice = (price, currency) => {
      return `${price.toLocaleString('ru-RU')} ${currency === 'USD' ? '$' : '‚ÇΩ'}`;
    };

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ Base64
    const filesToBase64 = async (files) => {
      const base64Images = [];
      const fileList = Array.from(files).slice(0, 3); // –ú–∞–∫—Å 3 —Ñ–æ—Ç–æ
      
      for (const file of fileList) {
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(file);
        });
        base64Images.push(base64);
      }
      
      return base64Images;
    };

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
    document.getElementById('adImages').addEventListener('change', function() {
      const thumbsContainer = document.getElementById('adThumbs');
      thumbsContainer.innerHTML = '';
      
      if (this.files.length > 0) {
        document.getElementById('adPreview').classList.remove('hidden');
        
        Array.from(this.files).slice(0, 3).forEach((file, i) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const thumb = document.createElement('img');
            thumb.src = e.target.result;
            thumb.className = 'thumb' + (i === 0 ? ' active' : '');
            thumb.onclick = () => {
              document.querySelectorAll('#adThumbs .thumb').forEach(t => t.classList.remove('active'));
              thumb.classList.add('active');
              document.getElementById('adPreview').src = e.target.result;
            };
            thumbsContainer.appendChild(thumb);
            
            if (i === 0) {
              document.getElementById('adPreview').src = e.target.result;
            }
          };
          reader.readAsDataURL(file);
        });
      }
    });

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    function renderAuthUI() {
      if (!currentUser) {
        authBar.innerHTML = `
          <button id="loginBtn" class="p-1 px-3 rounded-lg border">–í–æ–π—Ç–∏</button>
          <button id="registerBtn" class="p-1 px-3 rounded-lg bg-blue-600 text-white">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        `;
        
        document.getElementById('loginBtn').onclick = showLoginModal;
        document.getElementById('registerBtn').onclick = showRegisterModal;
      } else {
        authBar.innerHTML = `
          <span class="text-sm">${currentUser.displayName || currentUser.email}</span>
          <button id="logoutBtn" class="p-1 px-3 rounded-lg border">–í—ã–π—Ç–∏</button>
        `;
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
      }
    }

    function showLoginModal() {
      const modal = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg p-4 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-3">–í—Ö–æ–¥</h3>
            <input id="loginEmail" type="email" placeholder="Email" class="w-full border p-2 rounded-lg mb-2">
            <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full border p-2 rounded-lg mb-3">
            <button id="confirmLogin" class="w-full bg-blue-600 text-white p-2 rounded-lg">–í–æ–π—Ç–∏</button>
          </div>
        </div>
      `;
      
      const div = document.createElement('div');
      div.innerHTML = modal;
      document.body.appendChild(div);
      
      document.getElementById('confirmLogin').onclick = async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPass').value;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          div.remove();
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
        }
      };
      
      div.querySelector('.bg-black/50').onclick = () => div.remove();
    }

    function showRegisterModal() {
      const modal = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg p-4 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-3">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input id="regName" placeholder="–ò–º—è" class="w-full border p-2 rounded-lg mb-2">
            <input id="regEmail" type="email" placeholder="Email" class="w-full border p-2 rounded-lg mb-2">
            <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full border p-2 rounded-lg mb-3">
            <button id="confirmRegister" class="w-full bg-blue-600 text-white p-2 rounded-lg">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
        </div>
      `;
      
      const div = document.createElement('div');
      div.innerHTML = modal;
      document.body.appendChild(div);
      
      document.getElementById('confirmRegister').onclick = async () => {
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPass').value;
        
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(userCredential.user, { displayName: name });
          div.remove();
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
        }
      };
      
      div.querySelector('.bg-black/50').onclick = () => div.remove();
    }

    // –†–∞–±–æ—Ç–∞ —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
    async function saveAdHandler() {
      const title = document.getElementById('adTitle').value.trim();
      const description = document.getElementById('adDesc').value.trim();
      const price = Number(document.getElementById('adPrice').value);
      const currency = document.getElementById('adCurrency').value;
      const location = document.getElementById('adLocation').value.trim();
      const phone = document.getElementById('adPhone').value.trim();
      const images = await filesToBase64(document.getElementById('adImages').files);
      
      if (!title || !description || !price || !location || !phone) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
      }
      
      try {
        saveAd.disabled = true;
        saveAd.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        const adData = {
          title,
          description,
          price,
          currency,
          location,
          phone,
          images,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          createdAt: serverTimestamp()
        };
        
        if (editingAdId) {
          await updateDoc(doc(db, 'ads', editingAdId), adData);
        } else {
          await addDoc(collection(db, 'ads'), adData);
        }
        
        adModal.close();
        resetAdForm();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
      } finally {
        saveAd.disabled = false;
        saveAd.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }

    function resetAdForm() {
      document.getElementById('adTitle').value = '';
      document.getElementById('adDesc').value = '';
      document.getElementById('adPrice').value = '';
      document.getElementById('adLocation').value = '';
      document.getElementById('adPhone').value = '';
      document.getElementById('adImages').value = '';
      document.getElementById('adThumbs').innerHTML = '';
      document.getElementById('adPreview').src = '';
      document.getElementById('adPreview').classList.add('hidden');
      editingAdId = null;
    }

    function renderAds() {
      adsGrid.innerHTML = '';
      
      if (ads.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      ads.forEach(ad => {
        const adElement = document.createElement('div');
        adElement.className = 'border rounded-lg overflow-hidden bg-white';
        adElement.innerHTML = `
          <div class="aspect-[4/3] bg-gray-100">
            <img src="${ad.images?.[0] || 'https://via.placeholder.com/400x300?text=No+Image'}" class="w-full h-full object-cover">
          </div>
          <div class="p-3">
            <h3 class="font-bold truncate">${ad.title}</h3>
            <div class="flex justify-between items-center mt-1">
              <span class="font-bold text-blue-600">${formatPrice(ad.price, ad.currency)}</span>
              <span class="text-sm text-gray-600">${ad.location}</span>
            </div>
            <button class="w-full mt-2 p-2 bg-gray-100 rounded-lg text-sm">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          </div>
        `;
        
        adElement.querySelector('button').onclick = () => showAdDetails(ad);
        adsGrid.appendChild(adElement);
      });
    }

    function showAdDetails(ad) {
      document.getElementById('viewTitle').textContent = ad.title;
      document.getElementById('viewPrice').textContent = formatPrice(ad.price, ad.currency);
      document.getElementById('viewLocation').textContent = ad.location;
      document.getElementById('viewDesc').textContent = ad.description;
      document.getElementById('viewPhone').href = `tel:${ad.phone.replace(/\D/g, '')}`;
      document.getElementById('viewPhone').textContent = `–ü–æ–∑–≤–æ–Ω–∏—Ç—å: ${ad.phone}`;
      document.getElementById('viewUser').textContent = ad.userName;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
      const thumbsContainer = document.getElementById('viewThumbs');
      thumbsContainer.innerHTML = '';
      
      if (ad.images && ad.images.length > 0) {
        document.getElementById('viewImg').src = ad.images[0];
        
        ad.images.forEach((img, i) => {
          const thumb = document.createElement('img');
          thumb.src = img;
          thumb.className = 'thumb' + (i === 0 ? ' active' : '');
          thumb.onclick = () => {
            document.querySelectorAll('#viewThumbs .thumb').forEach(t => t.classList.remove('active'));
            thumb.classList.add('active');
            document.getElementById('viewImg').src = img;
          };
          thumbsContainer.appendChild(thumb);
        });
      } else {
        document.getElementById('viewImg').src = 'https://via.placeholder.com/800x600?text=No+Image';
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
      const ownerActions = document.getElementById('ownerActions');
      if (currentUser && ad.userId === currentUser.uid) {
        ownerActions.classList.remove('hidden');
        document.getElementById('editAdBtn').onclick = () => {
          editingAdId = ad.id;
          document.getElementById('adTitle').value = ad.title;
          document.getElementById('adDesc').value = ad.description;
          document.getElementById('adPrice').value = ad.price;
          document.getElementById('adCurrency').value = ad.currency;
          document.getElementById('adLocation').value = ad.location;
          document.getElementById('adPhone').value = ad.phone;
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ
          const thumbsContainer = document.getElementById('adThumbs');
          thumbsContainer.innerHTML = '';
          
          if (ad.images && ad.images.length > 0) {
            document.getElementById('adPreview').src = ad.images[0];
            document.getElementById('adPreview').classList.remove('hidden');
            
            ad.images.forEach((img, i) => {
              const thumb = document.createElement('img');
              thumb.src = img;
              thumb.className = 'thumb' + (i === 0 ? ' active' : '');
              thumb.onclick = () => {
                document.querySelectorAll('#adThumbs .thumb').forEach(t => t.classList.remove('active'));
                thumb.classList.add('active');
                document.getElementById('adPreview').src = img;
              };
              thumbsContainer.appendChild(thumb);
            });
          }
          
          viewDialog.close();
          adModal.showModal();
        };
        
        document.getElementById('deleteAdBtn').onclick = async () => {
          if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) {
            await deleteDoc(doc(db, 'ads', ad.id));
            viewDialog.close();
          }
        };
      } else {
        ownerActions.classList.add('hidden');
      }
      
      viewDialog.showModal();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      renderAuthUI();
      addBtn.disabled = !user;
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    onSnapshot(query(collection(db, 'ads'), orderBy('createdAt', 'desc')), (snapshot) => {
      ads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderAds();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    addBtn.addEventListener('click', () => {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      resetAdForm();
      adModal.showModal();
    });

    closeModal.addEventListener('click', () => adModal.close());
    closeView.addEventListener('click', () => viewDialog.close());
    saveAd.addEventListener('click', saveAdHandler);

    // –ü–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    searchInput.addEventListener('input', () => {
      const searchTerm = searchInput.value.toLowerCase();
      const filteredAds = ads.filter(ad => 
        ad.title.toLowerCase().includes(searchTerm) || 
        ad.description.toLowerCase().includes(searchTerm)
      );
      ads = filteredAds;
      renderAds();
    });

    sortSelect.addEventListener('change', () => {
      if (sortSelect.value === 'cheap') {
        ads.sort((a, b) => a.price - b.price);
      } else {
        ads.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);
      }
      renderAds();
    });
  </script>
</body>
</html>